# ============================================================
# Spectral Ruleset — OpenAPI/Swagger Contract Validation
# Extension of the standard OAS ruleset with custom rules
# to enforce organization REST standards
# ============================================================

extends:
  - "spectral:oas"

rules:
  # ──────────────────────────────────────────────────────────
  # Standard OAS rules (severity override)
  # ──────────────────────────────────────────────────────────
  operation-operationId: error
  operation-description: error
  info-description: error
  info-contact: warn
  oas3-api-servers: warn

  # ──────────────────────────────────────────────────────────
  # Custom rules — Organization REST standards
  # ──────────────────────────────────────────────────────────

  # All routes must have a 400 response mapped
  operation-must-have-400-response:
    description: "Every operation must map a 400 (Bad Request) response."
    severity: warn
    given: "$.paths[*][get,post,put,patch,delete]"
    then:
      field: "responses.400"
      function: truthy

  # kebab-case naming for paths
  paths-must-be-kebab-case:
    description: "Paths must use kebab-case (e.g. /my-resource, not /myResource)."
    severity: warn
    given: "$.paths"
    then:
      function: pattern
      functionOptions:
        match: "^(/[a-z0-9\\-{}]+)+$"
      field: "@key"

  # camelCase naming for schema properties
  properties-must-be-camel-case:
    description: "Schema properties must use camelCase."
    severity: warn
    given: "$..[?(@.type=='object')].properties"
    then:
      function: pattern
      functionOptions:
        match: "^[a-z][a-zA-Z0-9]*$"
      field: "@key"

  # Require tags on operations for organization
  operation-must-have-tags:
    description: "Every operation must have at least one tag."
    severity: warn
    given: "$.paths[*][get,post,put,patch,delete]"
    then:
      field: "tags"
      function: truthy

  # Require summary on operations
  operation-must-have-summary:
    description: "Every operation must have a summary."
    severity: warn
    given: "$.paths[*][get,post,put,patch,delete]"
    then:
      field: "summary"
      function: truthy

  # Prohibit paths with trailing slash
  no-trailing-slash:
    description: "Paths must not end with /."
    severity: error
    given: "$.paths"
    then:
      function: pattern
      functionOptions:
        notMatch: "\\/$"
      field: "@key"

  # Require content in responses with body
  response-must-have-content:
    description: "200/201 responses must have content defined."
    severity: warn
    given: "$.paths[*][*].responses[?(@property == '200' || @property == '201')]"
    then:
      field: "content"
      function: truthy
