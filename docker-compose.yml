services:
  sonarqube:
    image: ${SONAR_IMAGE:-ghcr.io/marcelo-davanco/sonarqube-with-community-branch-plugin:latest}
    container_name: sonarqube
    depends_on:
      db:
        condition: service_healthy
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://db:5432/${SONAR_DB_NAME:-sonarqube}
      SONAR_JDBC_USERNAME: ${SONAR_DB_USER:-sonar}
      SONAR_JDBC_PASSWORD: ${SONAR_DB_PASSWORD:-sonar}
    ports:
      - "${SONAR_PORT:-9000}:9000"
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_logs:/opt/sonarqube/logs
    networks:
      - sonar-network
    restart: unless-stopped

  db:
    image: ${SONAR_DB_IMAGE:-postgres:15-alpine}
    container_name: sonarqube-db
    environment:
      POSTGRES_USER: ${SONAR_DB_USER:-sonar}
      POSTGRES_PASSWORD: ${SONAR_DB_PASSWORD:-sonar}
      POSTGRES_DB: ${SONAR_DB_NAME:-sonarqube}
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    networks:
      - sonar-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${SONAR_DB_USER:-sonar} -d ${SONAR_DB_NAME:-sonarqube}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  scanner:
    build: ./apps/scanner
    image: ${SCANNER_IMAGE:-quality-scanner:latest}
    container_name: quality-scanner
    depends_on:
      sonarqube:
        condition: service_started
    environment:
      SONAR_HOST_URL: ${SONAR_INTERNAL_URL:-http://sonarqube:9000}
      SONAR_ADMIN_USER: ${SONAR_ADMIN_USER:-admin}
      SONAR_ADMIN_PASSWORD: ${SONAR_ADMIN_PASSWORD:-admin}
      SONAR_PUBLIC_URL: ${SONAR_PUBLIC_URL:-http://localhost:9000}
      SONAR_PROJECT_KEY: ${SONAR_PROJECT_KEY:-my-project}
      SONAR_TOKEN: ${SONAR_TOKEN:-}
      ENABLE_GITLEAKS: ${ENABLE_GITLEAKS:-true}
      ENABLE_TYPESCRIPT: ${ENABLE_TYPESCRIPT:-true}
      ENABLE_ESLINT: ${ENABLE_ESLINT:-true}
      ENABLE_PRETTIER: ${ENABLE_PRETTIER:-true}
      ENABLE_AUDIT: ${ENABLE_AUDIT:-true}
      ENABLE_KNIP: ${ENABLE_KNIP:-true}
      ENABLE_JEST: ${ENABLE_JEST:-true}
      ENABLE_SONARQUBE: ${ENABLE_SONARQUBE:-true}
      ENABLE_API_LINT: ${ENABLE_API_LINT:-false}
      API_LINT_SEVERITY: ${API_LINT_SEVERITY:-warn}
      OPENAPI_FILE_PATH: ${OPENAPI_FILE_PATH:-}
      ENABLE_INFRA_SCAN: ${ENABLE_INFRA_SCAN:-false}
      INFRA_SCAN_SEVERITY: ${INFRA_SCAN_SEVERITY:-HIGH}
      SCAN_DOCKERFILE: ${SCAN_DOCKERFILE:-true}
      SCAN_K8S: ${SCAN_K8S:-true}
      SCAN_COMPOSE: ${SCAN_COMPOSE:-true}
      # Branch & PR analysis (community-branch-plugin) â€” set only one block at a time
      SONAR_BRANCH_NAME: ${SONAR_BRANCH_NAME:-}
      SONAR_PR_KEY: ${SONAR_PR_KEY:-}
      SONAR_PR_BRANCH: ${SONAR_PR_BRANCH:-}
      SONAR_PR_BASE: ${SONAR_PR_BASE:-}
      SONAR_SCM_REVISION: ${SONAR_SCM_REVISION:-}
    volumes:
      - ${PROJECT_PATH:-.}/:/project
      - ${REPORTS_DIR:-./reports}:/reports
    networks:
      - sonar-network
    profiles:
      - scan

  api-db:
    image: ${API_DB_IMAGE:-postgres:15-alpine}
    container_name: quality-scanner-db
    environment:
      POSTGRES_USER: ${API_DB_USER:-scanner}
      POSTGRES_PASSWORD: ${API_DB_PASSWORD:-scanner}
      POSTGRES_DB: ${API_DB_NAME:-quality_scanner}
    volumes:
      - api_postgresql_data:/var/lib/postgresql/data
    ports:
      - "${API_DB_PORT:-5433}:5432"
    networks:
      - sonar-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${API_DB_USER:-scanner} -d ${API_DB_NAME:-quality_scanner}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  api:
    build: ./apps/api
    image: ${API_IMAGE:-quality-scanner-api:latest}
    container_name: quality-scanner-api
    depends_on:
      api-db:
        condition: service_healthy
    environment:
      API_PORT: ${API_PORT:-3001}
      API_DB_HOST: api-db
      API_DB_PORT: 5432
      API_DB_USER: ${API_DB_USER:-scanner}
      API_DB_PASSWORD: ${API_DB_PASSWORD:-scanner}
      API_DB_NAME: ${API_DB_NAME:-quality_scanner}
      API_DB_SYNC: ${API_DB_SYNC:-false}
    ports:
      - "${API_PORT:-3001}:3001"
    networks:
      - sonar-network
    restart: unless-stopped

volumes:
  sonarqube_data:
  sonarqube_logs:
  postgresql_data:
  api_postgresql_data:

networks:
  sonar-network:
    driver: bridge
