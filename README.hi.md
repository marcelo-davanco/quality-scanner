# Quality Scanner

> ЁЯМР **рдЕрдиреБрд╡рд╛рдж:** [English](./README.md) ┬╖ [Portugu├кs](./README.pt-BR.md) ┬╖ [ф╕нцЦЗ](./README.zh-CN.md) ┬╖ [Espa├▒ol](./README.es.md) ┬╖ [╨а╤Г╤Б╤Б╨║╨╕╨╣](./README.ru.md)

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](./LICENSE)
[![Release](https://img.shields.io/github/v/release/marcelo-davanco/quality-scanner)](https://github.com/marcelo-davanco/quality-scanner/releases)
[![CI](https://img.shields.io/github/actions/workflow/status/marcelo-davanco/quality-scanner/ci.yml?branch=develop&label=CI)](https://github.com/marcelo-davanco/quality-scanner/actions/workflows/ci.yml)

рдПрдХ **Nx рдореЛрдиреЛрд░реЗрдкреЛ** рдЬреЛ NestJS/TypeScript рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреВрд░реНрдг рдХреЛрдб рдЧреБрдгрд╡рддреНрддрд╛ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред [Community Branch Plugin](./docs/community-branch-plugin.md) рдХреЗ рд╕рд╛рде SonarQube Community Edition рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд, рдпрд╣ 10 рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд░рдг рдЪрд▓рд╛рддрд╛ рд╣реИ рдФрд░ рдПрдХ рд╕рдорд░реНрдкрд┐рдд REST API рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рднреА рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ PostgreSQL рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИред

## рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░

```
quality-scanner/ (Nx рдореЛрдиреЛрд░реЗрдкреЛ)
тФЬтФАтФА apps/scanner/     Docker-рдЖрдзрд╛рд░рд┐рдд 10-рдЪрд░рдг рдЧреБрдгрд╡рддреНрддрд╛ рдкрд╛рдЗрдкрд▓рд╛рдЗрди
тФЬтФАтФА apps/api/         NestJS REST API + TypeORM + PostgreSQL
тФФтФАтФА apps/dashboard/   Next.js рдкрд░рд┐рдгрд╛рдо рдбреИрд╢рдмреЛрд░реНрдб
```

### рд╕реЗрд╡рд╛рдПрдВ (docker compose)

| рд╕реЗрд╡рд╛         | рд╡рд┐рд╡рд░рдг                                          | рдкреЛрд░реНрдЯ |
|--------------|------------------------------------------------|-------|
| `sonarqube`  | SonarQube Community Edition                    | 9000  |
| `db`         | SonarQube рдХреЗ рд▓рд┐рдП PostgreSQL                    | 5432  |
| `api-db`     | API рдХреЗ рд▓рд┐рдП PostgreSQL                          | 5433  |
| `liquibase`  | API рд╢реБрд░реВ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ DB рдорд╛рдЗрдЧреНрд░реЗрд╢рди рдЪрд▓рд╛рддрд╛ рд╣реИ  | тАФ     |
| `api`        | NestJS REST API (рдкреНрд░реЛрдЬреЗрдХреНрдЯ, рд╕реНрдХреИрди, рдкреНрд░реЛрдлрд╛рдЗрд▓) | 3001  |
| `scanner`    | 10-рдЪрд░рдг рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдкрд╛рдЗрдкрд▓рд╛рдЗрди (рдорд╛рдВрдЧ рдкрд░)           | тАФ     |

---

## рдкреВрд░реНрд╡рд╛рдкреЗрдХреНрд╖рд╛рдПрдВ

- **Docker** рдФрд░ **Docker Compose**
- **Git**

> тЪая╕П macOS/Linux рдкрд░: `sudo sysctl -w vm.max_map_count=524288`
>
> **macOS Colima** рдкрд░: `colima start --memory 6 --cpu 4`

---

## рддреНрд╡рд░рд┐рдд рд╢реБрд░реБрдЖрдд

### 1. рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ

```bash
cp .env.example .env
```

| рдЪрд░                     | рд╡рд┐рд╡рд░рдг                                              |
|------------------------|----------------------------------------------------|
| `SONAR_ADMIN_PASSWORD` | SonarQube рдПрдбрдорд┐рди рдкрд╛рд╕рд╡рд░реНрдб (рдкрд╣рд▓реЗ рд▓реЙрдЧрд┐рди рдкрд░ рдмрджрд▓реЗрдВ)    |
| `SONAR_DB_PASSWORD`    | SonarQube рдХреЗ рд▓рд┐рдП PostgreSQL рдкрд╛рд╕рд╡рд░реНрдб               |
| `API_DB_PASSWORD`      | API рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд▓рд┐рдП PostgreSQL рдкрд╛рд╕рд╡рд░реНрдб             |

### 2. рд╕рднреА рд╕реЗрд╡рд╛рдПрдВ рд╢реБрд░реВ рдХрд░реЗрдВ

```bash
docker compose up -d
```

- **SonarQube:** [http://localhost:9000](http://localhost:9000) тАФ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд▓реЙрдЧрд┐рди `admin` / `admin`
- **API Swagger:** [http://localhost:3001/api/docs](http://localhost:3001/api/docs)
- **рдбреИрд╢рдмреЛрд░реНрдб:** [http://localhost:3000](http://localhost:3000)

### 3. рдЕрдкрдиреЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ `sonar-project-localhost.properties` рдЬреЛрдбрд╝реЗрдВ

```properties
sonar.projectKey=my-project
sonar.projectName=my-project
sonar.projectVersion=1.0.0
sonar.language=ts
sonar.sourceEncoding=UTF-8
sonar.sources=src/
sonar.exclusions=**/node_modules/**,**/dist/**,**/*.spec.ts
sonar.javascript.lcov.reportPaths=coverage/lcov.info
sonar.qualitygate.wait=false
sonar.scm.disabled=true
```

### 4. рд╕реНрдХреИрдирд░ рдЪрд▓рд╛рдПрдВ

```bash
./scan.sh /path/to/your/project
```

рд╕реНрдХреИрдирд░ API рдореЗрдВ рд╕реНрдХреИрди рдкрдВрдЬреАрдХреГрдд рдХрд░рддрд╛ рд╣реИ, рдЧреБрдгрд╡рддреНрддрд╛ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ, 10 рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд░рдг рдЪрд▓рд╛рддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдЪрд░рдг рдХрд╛ рдкрд░рд┐рдгрд╛рдо API рдХреЛ рд░рд┐рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕реНрдХреИрди рд░рд┐рдХреЙрд░реНрдб рдХреЛ рдЕрдВрддрд┐рдо рд░реВрдк рджреЗрддрд╛ рд╣реИред

### 5. рдкрд░рд┐рдгрд╛рдо рджреЗрдЦреЗрдВ

- **рдбреИрд╢рдмреЛрд░реНрдб:** [http://localhost:3000](http://localhost:3000)
- **SonarQube:** `http://localhost:9000/dashboard?id=<project-key>`
- **рд╕реНрдерд╛рдиреАрдп рд░рд┐рдкреЛрд░реНрдЯ:** `./reports/`

---

## рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд░рдг

| рдЪрд░рдг | рдЯреВрд▓            | рдХреНрдпрд╛ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ                                | рдбрд┐рдлрд╝реЙрд▓реНрдЯ    |
|-----|----------------|-----------------------------------------------|-------------|
| 1   | **Gitleaks**   | рд╣рд╛рд░реНрдбрдХреЛрдбреЗрдб рд╕реАрдХреНрд░реЗрдЯ рдФрд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓           | рд╕рдХреНрд╖рдо       |
| 2   | **TypeScript** | рд╕рдВрдХрд▓рди рддреНрд░реБрдЯрд┐рдпрд╛рдВ                               | рд╕рдХреНрд╖рдо       |
| 3   | **ESLint**     | рдХреЛрдб рдЧреБрдгрд╡рддреНрддрд╛ рдирд┐рдпрдо                             | рд╕рдХреНрд╖рдо       |
| 4   | **Prettier**   | рдХреЛрдб рдлреЙрд░реНрдореЗрдЯрд┐рдВрдЧ                                | рд╕рдХреНрд╖рдо       |
| 5   | **npm audit**  | рдирд┐рд░реНрднрд░рддрд╛ рдХрдордЬреЛрд░рд┐рдпрд╛рдВ                            | рд╕рдХреНрд╖рдо       |
| 6   | **Knip**       | рдбреЗрдб рдХреЛрдб (рдЕрдкреНрд░рдпреБрдХреНрдд exports, рдлрд╝рд╛рдЗрд▓реЗрдВ, deps)   | рд╕рдХреНрд╖рдо       |
| 7   | **Jest**       | рдЯреЗрд╕реНрдЯ + рдХрд╡рд░реЗрдЬ                                 | рд╕рдХреНрд╖рдо       |
| 8   | **SonarQube**  | рд╕реНрдЯреИрдЯрд┐рдХ рд╡рд┐рд╢реНрд▓реЗрд╖рдг + quality gate               | рд╕рдХреНрд╖рдо       |
| 9   | **Spectral**   | OpenAPI рдХреЙрдиреНрдЯреНрд░реИрдХреНрдЯ рд╡реИрд▓рд┐рдбреЗрд╢рди                  | рдЕрдХреНрд╖рдо       |
| 10  | **Trivy**      | рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рд╕реБрд░рдХреНрд╖рд╛ (IaC)               | рдЕрдХреНрд╖рдо       |

рдкреНрд░рддреНрдпреЗрдХ рдЪрд░рдг рдХреЛ `ENABLE_GITLEAKS`, `ENABLE_ESLINT`, `ENABLE_API_LINT` рдЖрджрд┐ рд╕реЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░реЗрдВред

---

## рдЧреБрдгрд╡рддреНрддрд╛ рдкреНрд░реЛрдлрд╛рдЗрд▓

рдЧреБрдгрд╡рддреНрддрд╛ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдкреБрди: рдЙрдкрдпреЛрдЧ рдпреЛрдЧреНрдп рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд╕реЗрдЯ (ESLint, Prettier, TypeScript, рдЖрджрд┐) рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдиреЗ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред рд╕реНрдХреИрди рдЪрд▓рдиреЗ рдкрд░, рд╕реНрдХреИрдирд░ `GET /api/projects/configs/:key` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЪрд░рдг рдЪрд▓рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЙрдиреНрд╣реЗрдВ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдХреЛрдИ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдЕрд╕рд╛рдЗрди рдирд╣реАрдВ рд╣реИ, рддреЛ `quality-configs/` рдХреЗ рд╕реНрдЯреИрдЯрд┐рдХ рдлрд╝рд╛рдЗрд▓реЗрдВ рдлрд╝реЙрд▓рдмреИрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рд╣реЛрддреА рд╣реИрдВред

**рдкреНрд░рдмрдВрдзрди:** [http://localhost:3000/quality-profiles](http://localhost:3000/quality-profiles)

---

## REST API

`http://localhost:3001/api` тАФ Swagger `/api/docs` рдкрд░

| рд╕рдВрд╕рд╛рдзрди           | рдПрдВрдбрдкреЙрдЗрдВрдЯ                                                                 |
|------------------|--------------------------------------------------------------------------|
| **рдкреНрд░реЛрдЬреЗрдХреНрдЯ**    | `POST/GET /projects` ┬╖ `GET/PATCH/DELETE /projects/:id`                  |
| **рд╕реНрдХреИрди**        | `POST /projects/:id/scans` ┬╖ `GET/PATCH /scans/:id`                      |
| **рдЪрд░рдг рдкрд░рд┐рдгрд╛рдо**   | `POST/GET /scans/:id/phases`                                             |
| **рдкреНрд░реЛрдлрд╛рдЗрд▓**     | `POST/GET /quality-profiles` ┬╖ `GET/PATCH/DELETE /quality-profiles/:id`  |
| **рдХреЙрдиреНрдлрд╝рд┐рдЧ рдЖрдЗрдЯрдо** | `POST/GET /quality-profiles/:id/configs` ┬╖ `PATCH/DELETE /quality-profiles/configs/:itemId` |
| **рд╕реНрдХреИрдирд░ рдХреЙрдиреНрдлрд╝рд┐рдЧ** | `GET /projects/configs/:key`                                          |

рд╕реНрдХреАрдорд╛ **Liquibase** рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд тАФ `liquibase` Docker рд╕реЗрд╡рд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдорд╛рдЗрдЧреНрд░реЗрд╢рдиред

---

## Branch рдФрд░ Pull Request рд╡рд┐рд╢реНрд▓реЗрд╖рдг

```bash
# Branch рд╡рд┐рд╢реНрд▓реЗрд╖рдг
SONAR_BRANCH_NAME=feature/my-branch ./scan.sh /path/to/project

# Pull Request рд╡рд┐рд╢реНрд▓реЗрд╖рдг
SONAR_PR_KEY=42 SONAR_PR_BRANCH=feature/my-branch SONAR_PR_BASE=main \
./scan.sh /path/to/project
```

---

## рдбреИрд╢рдмреЛрд░реНрдб

| рдкреЗрдЬ                                 | рд╡рд┐рд╡рд░рдг                                         |
|-------------------------------------|-----------------------------------------------|
| `/projects`                         | рд╕рднреА рдкрдВрдЬреАрдХреГрдд рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕реВрдЪреАрдмрджреНрдз рдХрд░реЗрдВ          |
| `/projects/:id`                     | рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╡рд┐рд╡рд░рдг, рд╕реНрдХреИрди рдЗрддрд┐рд╣рд╛рд╕, рдкреНрд░реЛрдлрд╛рдЗрд▓      |
| `/projects/:id/scans/:scanId`       | рдЪрд░рдг-рд╡рд╛рд░ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рд╕рд╛рде рд╕реНрдХреИрди рд╡рд┐рд╡рд░рдг          |
| `/quality-profiles`                 | рдЧреБрдгрд╡рддреНрддрд╛ рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕реВрдЪреАрдмрджреНрдз рдФрд░ рдмрдирд╛рдПрдВ          |
| `/quality-profiles/:id`             | рдХреЙрдиреНрдлрд╝рд┐рдЧ рдЖрдЗрдЯрдо рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░реЗрдВ, рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд▓рд┐рдВрдХ рдХрд░реЗрдВ |

---

## рдЙрдкрдпреЛрдЧреА рдХрдорд╛рдВрдб

| рдХрдорд╛рдВрдб                               | рд╡рд┐рд╡рд░рдг                          |
|-------------------------------------|--------------------------------|
| `docker compose up -d`              | рд╕рднреА рд╕реЗрд╡рд╛рдПрдВ рд╢реБрд░реВ рдХрд░реЗрдВ          |
| `docker compose down -v`            | рд░реЛрдХреЗрдВ рдФрд░ рд╕рднреА рдбреЗрдЯрд╛ рд╣рдЯрд╛рдПрдВ       |
| `docker compose logs -f api`        | API рд▓реЙрдЧ рджреЗрдЦреЗрдВ                  |
| `./scan.sh /path/to/project`        | рдкреВрд░реНрдг рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд▓рд╛рдПрдВ           |
| `npx nx build api`                  | API рдмрд┐рд▓реНрдб рдХрд░реЗрдВ                 |
| `npx nx dev dashboard`              | рдбреИрд╢рдмреЛрд░реНрдб dev рдореЛрдб рдореЗрдВ рдЪрд▓рд╛рдПрдВ    |

---

## рд╕рдорд╕реНрдпрд╛ рдирд┐рд╡рд╛рд░рдг

**SonarQube рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛрддрд╛:** `docker compose logs sonarqube` ┬╖ `sudo sysctl -w vm.max_map_count=524288`

**API рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛрддреА:** `docker compose logs api` ┬╖ `docker compose logs liquibase`

**рд╕реНрдХреИрдирд░ API рд╕реЗ рдХрдиреЗрдХреНрдЯ рдирд╣реАрдВ рд╣реЛрддрд╛:** рд╕реНрдХреИрдирд░ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ `API_URL=http://api:3001` рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВред

---

## рдпреЛрдЧрджрд╛рди

рдпреЛрдЧрджрд╛рди рдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ! Pull request рд╕рдмрдорд┐рдЯ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ [CONTRIBUTING.md](./CONTRIBUTING.md) рдкрдврд╝реЗрдВред

## рд▓рд╛рдЗрд╕реЗрдВрд╕

[MIT](./LICENSE)
