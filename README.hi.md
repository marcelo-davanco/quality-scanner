# Quality Scanner

> ЁЯМР **рдЕрдиреБрд╡рд╛рдж / ╪к╪▒╪м┘Е█Т:** [English](./README.md) ┬╖ [Portugu├кs](./README.pt-BR.md) ┬╖ [ф╕нцЦЗ](./README.zh-CN.md) ┬╖ [Espa├▒ol](./README.es.md) ┬╖ [╨а╤Г╤Б╤Б╨║╨╕╨╣](./README.ru.md)

NestJS/TypeScript рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рд▓рд┐рдП Docker-рдЖрдзрд╛рд░рд┐рдд рдХреЛрдб рдХреНрд╡рд╛рд▓рд┐рдЯреА рдкрд╛рдЗрдкрд▓рд╛рдЗрди, SonarQube Community Edition рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рддред рд╕реАрдХреНрд░реЗрдЯ рдбрд┐рдЯреЗрдХреНрд╢рди рд╕реЗ рд▓реЗрдХрд░ рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рддрдХ 10 рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд░рдг рдЪрд▓рд╛рддрд╛ рд╣реИ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рд╕реНрдХреИрди рдХреЗ рд▓рд┐рдП JSON рд░рд┐рдкреЛрд░реНрдЯ рдЬрдирд░реЗрдЯ рдХрд░рддрд╛ рд╣реИред

> *█М█Б ╪п╪│╪к╪з┘И█М╪▓ █Б┘Ж╪п█М ┘Е█М┌║ ┘Д┌й┌╛█М ┌п╪ж█М █Б█Т ╪м┘И █Б┘Ж╪п┘И╪│╪к╪з┘Ж█М ╪з┘И╪▒ ┘╛╪з┌й╪│╪к╪з┘Ж█М ╪п┘И┘Ж┘И┌║ ╪╡╪з╪▒┘Б█М┘Ж ┌й█Т ┘Д█М█Т ┘В╪з╪и┘Д ┘Б█Б┘Е █Б█Т█Ф ╪з╪▒╪п┘И ╪и┘И┘Д┘Ж█Т ┘И╪з┘Д█Т ╪н╪╢╪▒╪з╪к ╪и┌╛█М ╪з╪│ ┌п╪з╪ж█М┌И ┌й┘И ╪в╪│╪з┘Ж█М ╪│█Т ╪│┘Е╪м┌╛ ╪│┌й╪к█Т █Б█М┌║█Ф*

## рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ

- **Docker** рдФрд░ **Docker Compose**
- **Node.js** >= 18
- **npm** рдпрд╛ **yarn**

> тЪая╕П macOS/Linux рдкрд░, SonarQube рдХреЗ рд▓рд┐рдП рд╡рд░реНрдЪреБрдЕрд▓ рдореЗрдореЛрд░реА рд▓рд┐рдорд┐рдЯ рдмрдврд╝рд╛рдПрдБ:
> ```bash
> sudo sysctl -w vm.max_map_count=524288
> ```

## рддреНрд╡рд░рд┐рдд рд╢реБрд░реБрдЖрдд

### 1. рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ

```bash
cp .env.example .env
```

`.env` рдлрд╝рд╛рдЗрд▓ рдПрдбрд┐рдЯ рдХрд░реЗрдВ рдФрд░ рдЕрдкрдиреА рд╡реИрд▓реНрдпреВ рднрд░реЗрдВред рдкрд╣рд▓реА рдмрд╛рд░ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ `SONAR_TOKEN` рдмрджрд▓рдирд╛ рдЬрд╝рд░реВрд░реА рд╣реИ (рдЪрд░рдг 2 рджреЗрдЦреЗрдВ)ред

### 2. SonarQube рд╢реБрд░реВ рдХрд░реЗрдВ

```bash
docker compose up -d
```

~1 рдорд┐рдирдЯ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ, рдлрд┐рд░ **http://localhost:9000** рдЦреЛрд▓реЗрдВред

- **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд▓реЙрдЧрд┐рди:** `admin` / `admin`
- рдкрд╣рд▓реА рдмрд╛рд░ рд▓реЙрдЧрд┐рди рдкрд░ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдиреЗ рдХрд╛ рдЕрдиреБрд░реЛрдз рдЖрдПрдЧрд╛ред

### 3. рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЬрдирд░реЗрдЯ рдХрд░реЗрдВ

1. **My Account** тЖТ **Security** тЖТ **Generate Tokens** рдкрд░ рдЬрд╛рдПрдБ
2. **Project Analysis Token** рдЯрд╛рдЗрдк рдХрд╛ рдЯреЛрдХрди рдмрдирд╛рдПрдБ
3. рдЯреЛрдХрди рдХреЙрдкреА рдХрд░реЗрдВ рдФрд░ `.env` рдореЗрдВ рд╕реЗрдЯ рдХрд░реЗрдВ:

```env
SONAR_TOKEN=your_token_here
```

### 4. рд╕реНрдХреИрдирд░ рдЪрд▓рд╛рдПрдБ

```bash
# рд╡рд░реНрддрдорд╛рди рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реНрдХреИрди рдХрд░реЗрдВ
./scan.sh .

# рдХреЛрдИ рднреА Node.js/NestJS рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕реНрдХреИрди рдХрд░реЗрдВ
./scan.sh /path/to/your/project
```

рд╕реНрдХреИрдирд░ рдХрдВрдЯреЗрдирд░:

1. рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдбрд┐рдкреЗрдВрдбреЗрдВрд╕реА рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдЧрд╛
2. рд╕рднреА 10 рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд░рдг рдЪрд▓рд╛рдПрдЧрд╛
3. JSON рд░рд┐рдкреЛрд░реНрдЯ `./reports/<date>/<scan-id>/` рдореЗрдВ рд╕реЗрд╡ рдХрд░реЗрдЧрд╛

### 5. рдкрд░рд┐рдгрд╛рдо рджреЗрдЦреЗрдВ

- **SonarQube рдбреИрд╢рдмреЛрд░реНрдб:** http://localhost:9000/dashboard?id=your-project
- **рд▓реЛрдХрд▓ рд░рд┐рдкреЛрд░реНрдЯреНрд╕:** `./reports/`

---

## рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд░рдг

| рдЪрд░рдг | рдЯреВрд▓ | рдХреНрдпрд╛ рдЬрд╛рдБрдЪрддрд╛ рд╣реИ |
|-----|-----|----------------|
| 1 | **Gitleaks** | рд╣рд╛рд░реНрдбрдХреЛрдбреЗрдб рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдФрд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ |
| 2 | **TypeScript** | рдХрдВрдкрд╛рдЗрд▓реЗрд╢рди рдПрд░рд░ |
| 3 | **ESLint** | рдХреЛрдб рдХреНрд╡рд╛рд▓рд┐рдЯреА рдирд┐рдпрдо (рдХреЗрдВрджреНрд░реАрдХреГрдд рдХреЙрдиреНрдлрд╝рд┐рдЧ) |
| 4 | **Prettier** | рдХреЛрдб рдлреЙрд░реНрдореЗрдЯрд┐рдВрдЧ (рдХреЗрдВрджреНрд░реАрдХреГрдд рдХреЙрдиреНрдлрд╝рд┐рдЧ) |
| 5 | **npm audit** | рдбрд┐рдкреЗрдВрдбреЗрдВрд╕реА рд╡рд▓реНрдирд░реЗрдмрд┐рд▓рд┐рдЯреА |
| 6 | **Knip** | рдбреЗрдб рдХреЛрдб (рдЕрдиреБрдкрдпреЛрдЧреА exports, рдлрд╝рд╛рдЗрд▓реЗрдВ, deps) |
| 7 | **Jest** | рдЯреЗрд╕реНрдЯ + рдХрд╡рд░реЗрдЬ |
| 8 | **SonarQube** | рд╕реНрдЯреИрдЯрд┐рдХ рдПрдирд╛рд▓рд┐рд╕рд┐рд╕ + рдХреНрд╡рд╛рд▓рд┐рдЯреА рдЧреЗрдЯ |
| 9 | **Spectral** | OpenAPI рдХреЙрдиреНрдЯреНрд░реИрдХреНрдЯ рд╡реИрд▓рд┐рдбреЗрд╢рди *(рд╡реИрдХрд▓реНрдкрд┐рдХ)* |
| 10 | **Trivy** | рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА (IaC) *(рд╡реИрдХрд▓реНрдкрд┐рдХ)* |

---

## рд▓реЛрдХрд▓ рдкреНрд░реА-рдкреБрд╢ рдХреНрд╡рд╛рд▓рд┐рдЯреА рдЧреЗрдЯ

рдкреБрд╢ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд▓реЛрдХрд▓реА рд╡рд╣реА рдЬрд╛рдБрдЪ рдЪрд▓рд╛рдПрдБ:

```bash
chmod +x quality-gate.sh
./quality-gate.sh
```

---

## API Lint тАФ OpenAPI рдХреЙрдиреНрдЯреНрд░реИрдХреНрдЯ рд╡реИрд▓рд┐рдбреЗрд╢рди (рдЪрд░рдг 9)

**Spectral** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ OpenAPI/Swagger рдХреЙрдиреНрдЯреНрд░реИрдХреНрдЯ рд╡реИрд▓рд┐рдбреЗрдЯ рдХрд░рддрд╛ рд╣реИред

### рд╕рдХреНрд░рд┐рдпрдг

```bash
# рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЗ рдЬрд╝рд░рд┐рдП
ENABLE_API_LINT=true ./scan.sh /path/to/project

# docker-compose рдХреЗ рдЬрд╝рд░рд┐рдП
ENABLE_API_LINT=true docker compose --profile scan up scanner
```

### рдХреНрдпрд╛ рд╡реИрд▓рд┐рдбреЗрдЯ рд╣реЛрддрд╛ рд╣реИ

- рд╕рднреА рд░реВрдЯреНрд╕ рдореЗрдВ `400` рд░рд┐рд╕реНрдкреЙрдиреНрд╕ рдореИрдкреНрдб рд╣реИ
- Paths `kebab-case` рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ (рдЬреИрд╕реЗ `/my-resource`)
- Schema рдкреНрд░реЙрдкрд░реНрдЯреАрдЬрд╝ `camelCase` рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИрдВ
- рд╣рд░ рдСрдкрд░реЗрд╢рди рдореЗрдВ `operationId`, `description`, `summary` рдФрд░ `tags` рд╣реИрдВ
- Paths `/` рд╕реЗ рд╕рдорд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛрддреЗ
- `200`/`201` рд░рд┐рд╕реНрдкреЙрдиреНрд╕ рдореЗрдВ `content` рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╣реИ

### рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

| рд╡реЗрд░рд┐рдПрдмрд▓ | рдбрд┐рдлрд╝реЙрд▓реНрдЯ | рд╡рд┐рд╡рд░рдг |
|---------|---------|-------|
| `ENABLE_API_LINT` | `false` | рдЗрд╕ рдЪрд░рдг рдХреЛ рд╕рдХреНрд╖рдо/рдЕрдХреНрд╖рдо рдХрд░реЗрдВ |
| `API_LINT_SEVERITY` | `warn` | `warn` = рдХреЗрд╡рд▓ рд░рд┐рдкреЛрд░реНрдЯ, `error` = рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдмреНрд▓реЙрдХ |
| `OPENAPI_FILE_PATH` | *(auto-detect)* | OpenAPI рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдореИрдиреНрдпреБрдЕрд▓ рдкрд╛рде |

OpenAPI рдлрд╝рд╛рдЗрд▓ рдСрдЯреЛ-рдбрд┐рдЯреЗрдХреНрдЯ рд╣реЛрддреА рд╣реИ (`swagger.json`, `openapi.yaml`, рдЖрджрд┐)ред рд░реВрд▓реНрд╕ рдХрд╕реНрдЯрдорд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `scanner/configs/.spectral.yml` рдПрдбрд┐рдЯ рдХрд░реЗрдВред рдкреВрд░реА рдЧрд╛рдЗрдб: [`scanner/configs/README.md`](./scanner/configs/README.md)ред

---

## Infra Scan тАФ рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА (рдЪрд░рдг 10)

**Trivy** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `Dockerfile`, `docker-compose.yml` рдФрд░ Kubernetes рдореИрдирд┐рдлреЗрд╕реНрдЯ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИред

### рд╕рдХреНрд░рд┐рдпрдг

```bash
# рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЗ рдЬрд╝рд░рд┐рдП
ENABLE_INFRA_SCAN=true ./scan.sh /path/to/project

# docker-compose рдХреЗ рдЬрд╝рд░рд┐рдП
ENABLE_INFRA_SCAN=true docker compose --profile scan up scanner
```

### рдХреНрдпрд╛ рд╕реНрдХреИрди рд╣реЛрддрд╛ рд╣реИ

| рдЯрд╛рдЗрдк | рдбрд┐рдЯреЗрдХреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЗрдВ | рдЙрджрд╛рд╣рд░рдг рд╕рдорд╕реНрдпрд╛рдПрдБ |
|------|-----------------|----------------|
| **Dockerfile** | `Dockerfile`, `Dockerfile.*` | `latest` рдЯреИрдЧ, `USER` рдирд╣реАрдВ, `HEALTHCHECK` рдирд╣реАрдВ |
| **docker-compose** | `docker-compose.yml`, `compose.yaml` | `privileged: true`, рдПрдХреНрд╕рдкреЛрдЬрд╝реНрдб рдкреЛрд░реНрдЯреНрд╕ |
| **Kubernetes** | `deployment.yaml`, `service.yaml`, рдЖрджрд┐ | `hostNetwork`, `securityContext` рдЕрдиреБрдкрд╕реНрдерд┐рдд |

### рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

| рд╡реЗрд░рд┐рдПрдмрд▓ | рдбрд┐рдлрд╝реЙрд▓реНрдЯ | рд╡рд┐рд╡рд░рдг |
|---------|---------|-------|
| `ENABLE_INFRA_SCAN` | `false` | рдЗрд╕ рдЪрд░рдг рдХреЛ рд╕рдХреНрд╖рдо/рдЕрдХреНрд╖рдо рдХрд░реЗрдВ |
| `INFRA_SCAN_SEVERITY` | `HIGH` | рдиреНрдпреВрдирддрдо рдмреНрд▓реЙрдХрд┐рдВрдЧ рдЧрдВрднреАрд░рддрд╛: `CRITICAL`, `HIGH`, `MEDIUM`, `LOW` |
| `SCAN_DOCKERFILE` | `true` | Dockerfile рд╕реНрдХреИрдирд┐рдВрдЧ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ |
| `SCAN_K8S` | `true` | Kubernetes рдореИрдирд┐рдлреЗрд╕реНрдЯ рд╕реНрдХреИрдирд┐рдВрдЧ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ |
| `SCAN_COMPOSE` | `true` | docker-compose рд╕реНрдХреИрдирд┐рдВрдЧ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ |

рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рдкреЙрд▓рд┐рд╕реА рдХрд╕реНрдЯрдорд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `scanner/configs/trivy-policy.yaml` рдПрдбрд┐рдЯ рдХрд░реЗрдВред рдкреВрд░реА рдЧрд╛рдЗрдб: [`scanner/configs/README.md`](./scanner/configs/README.md)ред

---

## рдЙрдкрдпреЛрдЧреА рдХрдорд╛рдВрдбреНрд╕

| рдХрдорд╛рдВрдб | рд╡рд┐рд╡рд░рдг |
|-------|-------|
| `docker compose up -d` | SonarQube рд╢реБрд░реВ рдХрд░реЗрдВ |
| `docker compose down` | SonarQube рдмрдВрдж рдХрд░реЗрдВ |
| `docker compose down -v` | SonarQube рдмрдВрдж рдХрд░реЗрдВ рдФрд░ рд╕рднреА рдбреЗрдЯрд╛ рд╣рдЯрд╛рдПрдБ |
| `docker compose logs -f sonarqube` | SonarQube рд▓реЙрдЧреНрд╕ рджреЗрдЦреЗрдВ |
| `./scan.sh /path/to/project` | рдкреВрд░рд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд▓рд╛рдПрдБ |
| `./quality-gate.sh` | рд▓реЛрдХрд▓ рдкреНрд░реА-рдкреБрд╢ рдЬрд╛рдБрдЪ рдЪрд▓рд╛рдПрдБ |

---

## рд╕рдорд╕реНрдпрд╛ рдирд┐рд╡рд╛рд░рдг

### SonarQube рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛрддрд╛

```bash
# рд▓реЙрдЧреНрд╕ рдЬрд╛рдБрдЪреЗрдВ
docker compose logs sonarqube

# Linux/macOS рдкрд░ рд╕рд╛рдорд╛рдиреНрдп рд╕рдорд╛рдзрд╛рди
sudo sysctl -w vm.max_map_count=524288
```

### рдореЗрдореЛрд░реА рдПрд░рд░

`docker-compose.yml` рдореЗрдВ `sonarqube` рд╕рд░реНрд╡рд┐рд╕ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ:

```yaml
deploy:
  resources:
    limits:
      memory: 2g
```

### рд╕реНрдХреИрдирд░ рдлрд╝рд╛рдЗрд▓реЗрдВ рдирд╣реАрдВ рдвреВрдВрдв рдкрд╛рддрд╛

рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ `sonar-project.properties` рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд░реВрдЯ рдкрд░ рд╣реИ рдФрд░ рд╕рднреА рдкрд╛рде рд╕рд╣реА рд╣реИрдВред

---

## рдпреЛрдЧрджрд╛рди

рдпреЛрдЧрджрд╛рди рдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ! Pull Request рд╕рдмрдорд┐рдЯ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ [CONTRIBUTING.md](./CONTRIBUTING.md) рдкрдврд╝реЗрдВред

## рд▓рд╛рдЗрд╕реЗрдВрд╕

[MIT](./LICENSE)
